rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Check if the user is accessing their own User Profile doc
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper: Check ownership based on 'userId' field in the document
    // Ensures:
    // 1. User is authenticated.
    // 2. If modifying existing data, user must own it.
    // 3. If writing new data (create/update), 'userId' field must match their UID.
    function isResourceOwner() {
      return isAuthenticated() && 
             (resource == null || resource.data.userId == request.auth.uid) &&
             (request.resource == null || request.resource.data.userId == request.auth.uid);
    }

    // --- Collections ---

    // Users Collection (Keyed by Auth UID)
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Rutinas
    match /rutinas/{rutinaId} {
      allow read, write: if isResourceOwner();
    }

    // Ejercicios
    match /ejercicios/{ejercicioId} {
      allow read, write: if isResourceOwner();
    }

    // Workout Logs
    match /workout_logs/{logId} {
      allow read, write: if isResourceOwner();
    }

    // Weight Logs
    match /weight_logs/{logId} {
      allow read, write: if isResourceOwner();
    }

    // Measurement Logs
    match /measurement_logs/{logId} {
      allow read, write: if isResourceOwner();
    }
  }
}
